{% extends "base.html.twig" %}

{% block title %}Neuer Kostenvoranschlag - {{ parent() }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <div class="px-4 py-6 sm:px-0">
        <!-- Header -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Neuer Kostenvoranschlag</h2>
            <p class="text-gray-600">Erstellen Sie einen Kostenvoranschlag für Reparatur oder Service</p>
        </div>

        <!-- Error Message -->
        {% if error %}
            <div class="mb-6 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
                {{ error }}
            </div>
        {% endif %}

        <!-- Form -->
        <div class="mediahuus-form-section">
            <form method="POST" action="/estimates" class="space-y-8">
                
                <!-- Filiale auswählen -->
                <div class="border-b border-gray-200 pb-8">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Filiale</h3>
                    <div>
                        <label for="branch_id" class="mediahuus-label">
                            Filiale auswählen *
                        </label>
                        <select name="branch_id" id="branch_id" required
                                class="mediahuus-select {{ errors.branch_id ? 'error' : '' }}">
                            <option value="">-- Filiale auswählen --</option>
                            {% for branch in branches %}
                                <option value="{{ branch.id }}" 
                                        {% if formData.branch_id|default('') == branch.id %}selected{% endif %}>
                                    {{ branch.name }} - {{ branch.full_address }}
                                </option>
                            {% endfor %}
                        </select>
                        {% if errors.branch_id %}
                            <p class="mt-1 text-sm text-red-600">{{ errors.branch_id }}</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Kundendaten -->
                <div class="border-b border-gray-200 pb-8">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Kundendaten</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Kundenname -->
                        <div class="md:col-span-2">
                            <label for="customer_name" class="mediahuus-label">
                                Name des Kunden *
                            </label>
                            <input type="text" name="customer_name" id="customer_name" required
                                   value="{{ formData.customer_name|default('') }}"
                                   class="mediahuus-input {{ errors.customer_name ? 'error' : '' }}"
                                   placeholder="Max Mustermann">
                            {% if errors.customer_name %}
                                <p class="mt-1 text-sm text-red-600">{{ errors.customer_name }}</p>
                            {% endif %}
                        </div>

                        <!-- Telefon -->
                        <div>
                            <label for="customer_phone" class="mediahuus-label">
                                Telefon
                            </label>
                            <input type="tel" name="customer_phone" id="customer_phone"
                                   value="{{ formData.customer_phone|default('') }}"
                                   class="mediahuus-input {{ errors.customer_phone ? 'error' : '' }}"
                                   placeholder="+41 61 123 45 67">
                            {% if errors.customer_phone %}
                                <p class="mt-1 text-sm text-red-600">{{ errors.customer_phone }}</p>
                            {% endif %}
                        </div>

                        <!-- E-Mail -->
                        <div>
                            <label for="customer_email" class="mediahuus-label">
                                E-Mail
                            </label>
                            <input type="email" name="customer_email" id="customer_email"
                                   value="{{ formData.customer_email|default('') }}"
                                   class="mediahuus-input {{ errors.customer_email ? 'error' : '' }}"
                                   placeholder="kunde@example.com">
                            {% if errors.customer_email %}
                                <p class="mt-1 text-sm text-red-600">{{ errors.customer_email }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Gerätedaten -->
                <div class="border-b border-gray-200 pb-8">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Geräteinformationen</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Gerätename -->
                        <div>
                            <label for="device_name" class="mediahuus-label">
                                Gerätename / Modell *
                            </label>
                            <input type="text" name="device_name" id="device_name" required
                                   value="{{ formData.device_name|default('') }}"
                                   class="mediahuus-input {{ errors.device_name ? 'error' : '' }}"
                                   placeholder="z.B. iPhone 15 Pro, Samsung Galaxy S24">
                            {% if errors.device_name %}
                                <p class="mt-1 text-sm text-red-600">{{ errors.device_name }}</p>
                            {% endif %}
                        </div>

                        <!-- Seriennummer -->
                        <div>
                            <label for="serial_number" class="mediahuus-label">
                                Seriennummer *
                            </label>
                            <input type="text" name="serial_number" id="serial_number" required
                                   value="{{ formData.serial_number|default('') }}"
                                   class="mediahuus-input {{ errors.serial_number ? 'error' : '' }}"
                                   placeholder="z.B. IMEI oder Seriennummer">
                            {% if errors.serial_number %}
                                <p class="mt-1 text-sm text-red-600">{{ errors.serial_number }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Schadensbeschreibung und Preis -->
                <div class="pb-8">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Reparaturdetails</h3>
                    <div class="space-y-6">
                        <!-- Schadensbeschreibung -->
                        <div>
                            <label for="issue_text" class="mediahuus-label">
                                Schaden/Fehlerbeschreibung *
                            </label>
                            <div class="mediahuus-richtext">
                                <div id="issue_text_editor" style="height: 200px;"></div>
                                <textarea name="issue_text" id="issue_text" required style="display: none;">{{ formData.issue_text|default('') }}</textarea>
                            </div>
                            {% if errors.issue_text %}
                                <p class="mt-1 text-sm text-red-600">{{ errors.issue_text }}</p>
                            {% endif %}
                        </div>

                        <!-- Preis -->
                        <div>
                            <label for="price_chf" class="mediahuus-label">
                                Voraussichtliche Kosten (CHF) *
                            </label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">CHF</span>
                                </div>
                                <input type="number" name="price_chf" id="price_chf" step="0.05" min="0" required
                                       value="{{ formData.price_chf|default('') }}"
                                       class="mediahuus-input {{ errors.price_chf ? 'error' : '' }}"
                                       style="padding-left: 4rem !important;"
                                       placeholder="0.00">
                            </div>
                            {% if errors.price_chf %}
                                <p class="mt-1 text-sm text-red-600">{{ errors.price_chf }}</p>
                            {% endif %}
                            <p class="mt-1 text-sm text-gray-500">Geben Sie den geschätzten Reparaturpreis in CHF ein.</p>
                        </div>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="flex justify-end space-x-3 pt-6 border-t">
                    <a href="{{ url_for('estimates.index') }}" 
                       class="mediahuus-button-secondary">
                        Abbrechen
                    </a>
                    <button type="submit" 
                            class="mediahuus-button-primary">
                        Kostenvoranschlag erstellen
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Quill Rich Text Editor
var quill = new Quill('#issue_text_editor', {
    theme: 'snow',
    placeholder: 'Beschreiben Sie den Schaden oder das Problem detailliert...',
    modules: {
        toolbar: [
            ['bold', 'italic', 'underline'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['link'],
            ['clean']
        ]
    }
});

// Sync with hidden textarea for form submission
var hiddenTextarea = document.querySelector('#issue_text');
var initialContent = hiddenTextarea.value;
if (initialContent) {
    quill.root.innerHTML = initialContent;
}

quill.on('text-change', function() {
    hiddenTextarea.value = quill.root.innerHTML;
});

// Ensure content is synced before form submission
document.querySelector('form').addEventListener('submit', function() {
    hiddenTextarea.value = quill.root.innerHTML;
});
</script>
{% endblock %}